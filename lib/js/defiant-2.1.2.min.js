/*
 * defiant.js [v2.1.2]
 * http://www.defiantjs.com
 * Copyright (c) 2013-2018 Hakan Bilgin <hbi@longscript.com>
 * License GNU AGPLv3
 */!function(window,module,undefined){"use strict";var Defiant={is_ie:/(msie|trident)/i.test(navigator.userAgent),is_safari:/safari/i.test(navigator.userAgent),env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,snapshots:{},render_xml:function(e,t){var n=new XSLTProcessor,r=document.createElement("span"),a='//xsl:template[@name="'+e+'"]',s=this.node.selectSingleNode(this.xsl_template,a);return(s=this.node.selectSingleNode(this.xsl_template,a)).setAttribute("match","/"),n.importStylesheet(this.xsl_template),r.appendChild(n.transformToFragment(t,document)),s.removeAttribute("match"),r.innerHTML},render:function(e,t){var n,r,a,s,o=new XSLTProcessor,i=document.createElement("span"),l={match:"/"};switch(typeof e){case"object":this.extend(l,e),l.data||(l.data=t);break;case"string":l.template=e,l.data=t;break;default:throw"error"}if(l.data=JSON.toXML(l.data),n='//xsl:template[@name="'+l.template+'"]',this.xsl_template||this.gatherTemplates(),l.sorter&&(s=this.node.selectSingleNode(this.xsl_template,n+"//xsl:for-each//xsl:sort"))&&(l.sorter.order&&s.setAttribute("order",l.sorter.order),l.sorter.select&&s.setAttribute("select",l.sorter.select),s.setAttribute("data-type",l.sorter.type||"text")),(a=this.node.selectSingleNode(this.xsl_template,n)).setAttribute("match",l.match),o.importStylesheet(this.xsl_template),i.appendChild(o.transformToFragment(l.data,document)),a.removeAttribute("match"),this.is_safari)for(var c=0,u=(r=i.getElementsByTagName("script")).length;c<u;c++)r[c].defer=!0;return i.innerHTML},gatherTemplates:function(){for(var e=document.getElementsByTagName("script"),t="",n=0,r=e.length;n<r;n++)"defiant/xsl-template"===e[n].type&&(t+=e[n].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:xlink="http://www.w3.org/1999/xlink" '+this.namespace+">"+t.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},getSnapshot:function(e,t){return JSON.toXML(e,t||!0)},createSnapshot:function(e,t){var n=this,r="snapshot_"+Date.now();JSON.toXML(e,function(e){n.snapshots[r]=e,t(r)})},xmlFromString:function(e){var t;return null===(e=e.replace(/>\s{1,}</g,"><")).trim().match(/<\?xml/)&&(e=this.xml_decl+e),"ActiveXObject"in window?((t=new ActiveXObject("Msxml2.DOMDocument")).loadXML(e),t.setProperty("SelectionNamespaces",this.namespace),-1===e.indexOf("xsl:stylesheet")&&t.setProperty("SelectionLanguage","XPath")):t=(new DOMParser).parseFromString(e,"text/xml"),t},extend:function(e,t){for(var n in t)e[n]&&"object"==typeof t[n]?this.extend(e[n],t[n]):e[n]=t[n];return e},node:{}},x10={work_handler:function(e){var t=Array.prototype.slice.call(e.data,1),n=e.data[0],r=tree[n].apply(tree,t);postMessage([n,r])},setup:function(e){var t=window.URL||window.webkitURL,n="var tree = {"+this.parse(e).join(",")+"};",r=new Blob([n+'self.addEventListener("message", '+this.work_handler.toString()+", false);"],{type:"text/javascript"}),a=new Worker(t.createObjectURL(r));return a.onmessage=function(e){var t=Array.prototype.slice.call(e.data,1),n=e.data[0];x10.observer.emit("x10:"+n,t)},a},call_handler:function(e,t){return function(){var n=Array.prototype.slice.call(arguments,0,-1),r=arguments[arguments.length-1];n.unshift(e),x10.observer.on("x10:"+e,function(e){r(e.detail[0])}),t.postMessage(n)}},compile:function(e){var t,n=this.setup("function"==typeof e?{func:e}:e),r={};if("function"==typeof e)return r.func=this.call_handler("func",n),r.func;for(t in e)r[t]=this.call_handler(t,n);return r},parse:function(e,t){var n,r,a,s=[];for(n in e)if(null!==(a=e[n]))if(a!==undefined){switch(a.constructor){case Date:r="new Date("+a.valueOf()+")";break;case Object:r="{"+this.parse(a).join(",")+"}";break;case Array:r="["+this.parse(a,!0).join(",")+"]";break;case String:r='"'+a.replace(/"/g,'\\"')+'"';break;case RegExp:case Function:r=a.toString();break;default:r=a}t?s.push(r):s.push(n+":"+r)}else s.push(n+":undefined");else s.push(n+":null");return s},observer:(stack={},{on:function(e,t){stack[e]||(stack[e]=[]),stack[e].unshift(t)},off:function(e,t){if(stack[e]){var n=stack[e].indexOf(t);stack[e].splice(n,1)}},emit:function(e,t){if(stack[e])for(var n={type:e,detail:t,isCanceled:!1,cancelBubble:function(){this.isCanceled=!0}},r=stack[e].length;r--;){if(n.isCanceled)return;stack[e][r](n)}}})},stack;if(void 0===XSLTProcessor){var XSLTProcessor=function(){};XSLTProcessor.prototype={importStylesheet:function(e){this.xsldoc=e},transformToFragment:function(e,t){var n=e.transformNode(this.xsldoc),r=document.createElement("span");return r.innerHTML=n,r}}}else if("function"!=typeof XSLTProcessor&&!XSLTProcessor)throw"XSLTProcessor transformNode not implemented";String.prototype.fill||(String.prototype.fill=function(e,t){var n=this;for(t=t||" ";n.length<e;n+=t);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.xTransform||(String.prototype.xTransform=function(){var e=this;return-1===this.indexOf("translate(")&&(e=this.replace(/contains\(([^,]+),([^\\)]+)\)/g,function(e,t,n){var r="abcdefghijklmnopqrstuvwxyz";return"contains(translate("+t+', "'+r.toUpperCase()+'", "'+r+'"),'+n.toLowerCase()+")"})),e.toString()}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(e){if(e instanceof Object){var t="";if(e.constructor===Array){for(var n=0;n<e.length;t+=this.stringify(e[n])+",",n++);return"["+t.substr(0,t.length-1)+"]"}if(e.toString!==Object.prototype.toString)return'"'+e.toString().replace(/"/g,"\\$&")+'"';for(var r in e)t+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(e[r])+",";return"{"+t.substr(0,t.length-1)+"}"}return"string"==typeof e?'"'+e.replace(/"/g,"\\$&")+'"':String(e)}}),JSON.toXML||(JSON.toXML=function(e,t){var n,r,a={map:[],rx_validate_name:/^(?!xml)[a-z_][\w\d.:]*$/i,rx_node:/<(.+?)( .*?)>/,rx_constructor:/<(.+?)( d:contr=".*?")>/,rx_namespace:/ xmlns\:d="defiant\-namespace"/,rx_data:/(<.+?>)(.*?)(<\/d:data>)/i,rx_function:/function (\w+)/i,namespace:'xmlns:d="defiant-namespace"',to_xml_str:function(e){return{str:this.hash_to_xml(null,e),map:this.map}},hash_to_xml:function(e,t,n){var r,a,s,o,i,l,c,u,d,p=t.constructor===Array,h=this,m=[],f=[],g=function(t,r){if(null!==(a=r[t])&&a!==undefined&&"NaN"!==a.toString()||(a=null),o="@"===t.slice(0,1),(i=n?e:t)==+i&&r.constructor!==Object&&(i="d:item"),null===a?(l=null,c=!1):(l=a.constructor,c=l.toString().match(h.rx_function)[1]),o)f.push(i.slice(1)+'="'+h.escape_xml(a)+'"'),"String"!==c&&f.push("d:"+i.slice(1)+'="'+c+'"');else if(null===a)m.push(h.scalar_to_xml(i,a));else switch(l){case Function:throw"JSON data should not contain functions. Please check your structure.";case Object:m.push(h.hash_to_xml(i,a));break;case Array:if(t===i){if(s=a.constructor===Array)for(u=a.length;u--;)null!==a[u]&&a[u]&&a[u].constructor!==Array||(s=!0),s||a[u].constructor!==Object||(s=!0);m.push(h.scalar_to_xml(i,a,s));break}case String:if("string"==typeof a&&(a=a.toString().replace(/\&/g,"&amp;").replace(/\r|\n/g,"&#13;")),"#text"===i){h.map.push(r),f.push('d:mi="'+h.map.length+'"'),f.push('d:constr="'+c+'"'),m.push(h.escape_xml(a));break}case Number:case Boolean:if("#text"===i&&"String"!==c){h.map.push(r),f.push('d:mi="'+h.map.length+'"'),f.push('d:constr="'+c+'"'),m.push(h.escape_xml(a));break}m.push(h.scalar_to_xml(i,a))}};if(t.constructor===Array)for(u=0,d=t.length;u<d;u++)g(u.toString(),t);else for(r in t)g(r,t);return e||(e="d:data",f.push(this.namespace),p&&f.push('d:constr="Array"')),null===e.match(this.rx_validate_name)&&(f.push('d:name="'+e+'"'),e="d:name"),n?m.join(""):(this.map.push(t),f.push('d:mi="'+this.map.length+'"'),"<"+e+(f.length?" "+f.join(" "):"")+(m.length?">"+m.join("")+"</"+e+">":"/>"))},scalar_to_xml:function(e,t,n){var r,a,s,o="";if(null===e.match(this.rx_validate_name)&&(o+=' d:name="'+e+'"',e="d:name",n=!1),null!==t&&"NaN"!==t.toString()||(t=null),null===t)return"<"+e+' d:constr="null"/>';if(1===t.length&&t.constructor===Array&&!t[0])return"<"+e+' d:constr="null" d:type="ArrayItem"/>';if(1===t.length&&t[0].constructor===Object){var i=(r=this.hash_to_xml(!1,t[0])).match(this.rx_node),l=r.match(this.rx_constructor);return"<"+e+(i=null!==i?i[2].replace(this.rx_namespace,"").replace(/>/,"").replace(/"\/$/,'"'):"")+" "+(l=null!==l?l[2]:"")+' d:type="ArrayItem">'+(r=null!==(r=r.match(this.rx_data))?r[2]:"")+"</"+e+">"}return 0===t.length&&t.constructor===Array?"<"+e+' d:constr="Array"/>':n?this.hash_to_xml(e,t,!0):(s=(a=t.constructor).toString().match(this.rx_function)[1],r=a===Array?this.hash_to_xml("d:item",t,!0):this.escape_xml(t),o+=' d:constr="'+s+'"',this.map.push(t),o+=' d:mi="'+this.map.length+'"',"#text"===e?this.escape_xml(t):"<"+e+o+">"+r+"</"+e+">")},escape_xml:function(e){return String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/&nbsp;/g,"&#160;")}};switch(typeof t){case"function":return void x10.compile(a).to_xml_str(e,function(n){t({doc:Defiant.xmlFromString(n.str),src:e,map:n.map})});case"boolean":return n=a.to_xml_str.call(a,e),{doc:Defiant.xmlFromString(n.str),src:e,map:n.map};default:return n=a.to_xml_str.call(a,e),r=Defiant.xmlFromString(n.str),this.search.map=n.map,r}}),JSON.search||(JSON.search=function(e,t,n){e.constructor===String&&"snapshot_"===e.slice(0,9)&&Defiant.snapshots[e]&&(e=Defiant.snapshots[e]);var r,a,s=e.doc&&e.doc.nodeType,o=s?e.doc:JSON.toXML(e),i=s?e.map:this.search.map,l=s?e.src:e,c=Defiant.node[n?"selectSingleNode":"selectNodes"](o,t.xTransform()),u=[];for(n&&(c=[c]),a=c.length;a--;)switch(c[a].nodeType){case 2:case 3:u.unshift(c[a].nodeValue);break;default:r=+c[a].getAttribute("d:mi"),u.unshift(i[r-1])}return"development"===Defiant.env&&(this.trace=JSON.mtrace(l,u,c)),u}),JSON.mtrace||(JSON.mtrace=((e,t,n)=>{var r=[],a=0,s=window,o=Defiant.node.toJSON,i=e=>JSON.stringify(e,null,"\t").replace(/\t/g,""),l=i(e);return n.map((e,c)=>{var u,d,p,h,m,f,g,x=0;switch(e.nodeType){case 2:u=n[c].ownerElement?n[c].ownerElement.getAttribute("d:"+n[c].nodeName):"String",h=s[u](t[c]),m='"@'+n[c].nodeName+'": '+h,f=l.indexOf(m,a);break;case 3:u=n[c].parentNode.getAttribute("d:constr"),h=s[u](t[c]),m='"'+n[c].parentNode.nodeName+'": '+("Number"===m?h:'"'+h+'"'),f=l.indexOf(m,a);break;default:u=e.getAttribute("d:constr"),["String","Number"].indexOf(u)>-1?(d=o(n[c].parentNode),p=i(d),h=s[u](t[c]),m='"'+n[c].nodeName+'": '+("Number"===u?h:'"'+h+'"'),f=l.indexOf(p,a)+p.indexOf(m)):(m=i(t[c]),f=l.indexOf(m),x=m.split("\n").length-1)}a=f+1,g=l.slice(0,f).split("\n").length,r.push([g,x])}),r})),Defiant.node.selectNodes=function(e,t){if(e.evaluate){for(var n=e.createNSResolver(e.documentElement),r=e.evaluate(t,e,n,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),a=[],s=0,o=r.snapshotLength;s<o;s++)a.push(r.snapshotItem(s));return a}return e.selectNodes(t)},Defiant.node.selectSingleNode=function(e,t){if(e.evaluate){var n=this.selectNodes(e,t);return n.length>0?n[0]:null}return e.selectSingleNode(t)},Defiant.node.prettyPrint=function(e){var t,n=Defiant,r=n.tabsize,a=n.xml_decl.toLowerCase();t=n.is_ie?e.xml:(new XMLSerializer).serializeToString(e),"development"!==n.env&&(t=t.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,o,i=t.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3").split("\n"),l=-1,c=0,u=i.length;c<u;c++)0===c&&i[c].toLowerCase()===a||(s=null!==i[c].match(/<[A-Za-z_\:]+.*?>/g),o=null!==i[c].match(/<\/[\w\:]+>/g),null!==i[c].match(/<.*?\/>/g)&&(s=o=!0),s&&l++,i[c]=String().fill(l,"\t")+i[c],s&&o&&l--,!s&&o&&l--);return i.join("\n").replace(/\t/g,String().fill(r," "))},Defiant.node.toJSON=function(e,t){var n=function(e){var t,r,a,s,o,i,l,c,u,d,p={},h=window;switch(e.nodeType){case 1:for("Array"===(o=e.getAttribute("d:constr"))?p=[]:"String"===o&&""===e.textContent&&(p=""),c=0,u=(t=e.attributes).length;c<u;c++)null===(d=t.item(c)).nodeName.match(/\:d|d\:/g)&&(i=(o=e.getAttribute("d:"+d.nodeName))&&"undefined"!==o?"null"===d.nodeValue?null:h[o]("false"===d.nodeValue?"":d.nodeValue):d.nodeValue,p["@"+d.nodeName]=i);break;case 3:p=i=(r=e.parentNode.getAttribute("d:type"))?h[r]("false"===e.nodeValue?"":e.nodeValue):e.nodeValue}if(e.hasChildNodes())for(c=0,u=e.childNodes.length;c<u;c++)if(s=(a=e.childNodes.item(c)).nodeName,t=e.attributes,"d:name"===s&&(s=a.getAttribute("d:name")),"#text"===s)"undefined"===(o=e.getAttribute("d:constr"))&&(o=undefined),l=a.textContent||a.text,i="Boolean"===o&&"false"===l?"":l,o||t.length?o&&1===u?p=h[o](i):e.hasChildNodes()&&t.length<3?p=o?h[o](i):i:p[s]=o?h[o](i):i:p=i;else{if("null"===a.getAttribute("d:constr")){p[s]&&p[s].push?p[s].push(null):"ArrayItem"===a.getAttribute("d:type")?p[s]=[p[s]]:p[s]=null;continue}if(p[s]){p[s].push?p[s].push(n(a)):p[s]=[p[s],n(a)];continue}switch(o=a.getAttribute("d:constr")){case"null":p.push?p.push(null):p[s]=null;break;case"Array":a.parentNode.firstChild===a&&"Array"===o&&"d:item"!==s?"d:item"===s||"Array"===o?(i=n(a),p[s]=i.length?[i]:i):p[s]=n(a):p.push?p.push(n(a)):p[s]=n(a);break;case"String":case"Number":case"Boolean":l=a.textContent||a.text,i="Boolean"===o&&"false"===l?"":l,p.push?p.push(h[o](i)):p[s]=n(a);break;default:p.push?p.push(n(a)):p[s]=n(a)}}return 1===e.nodeType&&"ArrayItem"===e.getAttribute("d:type")&&(p=[p]),p},r=9===e.nodeType?e.documentElement:e,a=n(r),s=a[r.nodeName];return r===r.ownerDocument.documentElement&&s&&s.constructor===Array&&(a=s),t&&"true"===t.toString()&&(t="\t"),t?JSON.stringify(a,null,t):a},"undefined"!=typeof jQuery&&(jQuery.fn.defiant=function(e,t){return this.html(Defiant.render(e,t)),this}),window.Defiant=module.exports=Defiant}("undefined"!=typeof window?window:{},"undefined"!=typeof module?module:{});